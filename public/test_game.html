<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe Test</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 5px;
      margin: 20px auto;
    }
    .cell {
      width: 100px;
      height: 100px;
      font-size: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #eee;
      cursor: pointer;
    }
    .disabled {
      pointer-events: none;
      background-color: #ddd;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>Tic Tac Toe (WebSocket Test)</h2>
  <button onclick="connect()">Connect & Find Match</button>
  <div id="status">Not connected</div>

  <div id="board"></div>

  <script>
    let socket;
    let symbol = "";
    let myTurn = false;
    const board = Array(9).fill("");

    function connect() {
      fetch("http://localhost:8080/api/nickname", { credentials: "include" })
        .then(res => res.json())
        .then(data => {
          console.log("Your nickname:", data.nickname);

          socket = new WebSocket("ws://localhost:8080/ws");

          socket.onopen = () => {
            console.log("WebSocket connected");
            socket.send(JSON.stringify({ type: "find_match" }));
            document.getElementById("status").textContent = "Finding match...";
          };

          socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("From server:", msg);

            if (msg.type === "match_found") {
              symbol = msg.symbol;
              myTurn = (symbol === "X");
              document.getElementById("status").textContent = "Match found! You are " + symbol + ".";
              renderBoard();
            }

            if (msg.type === "move_made") {
              board[msg.cell] = msg.by;
              myTurn = (msg.by !== symbol);
              renderBoard();
            }

            if (msg.type === "game_over") {
              document.getElementById("status").textContent = "Game Over: " + (msg.result === "draw" ? "Draw" : (msg.result + " wins"));
              disableBoard();
            }
          };

          socket.onclose = () => {
            console.log("WebSocket closed");
            document.getElementById("status").textContent = "Connection closed";
          };

          socket.onerror = (err) => {
            console.error("WebSocket error:", err);
          };
        })
        .catch(err => {
          console.error("Fetch error:", err);
        });
    }

    function renderBoard() {
      const boardDiv = document.getElementById("board");
      boardDiv.innerHTML = "";

      board.forEach((cell, idx) => {
        const div = document.createElement("div");
        div.className = "cell";
        div.textContent = cell;
        if (cell === "" && myTurn) {
          div.onclick = () => makeMove(idx);
        } else {
          div.classList.add("disabled");
        }
        boardDiv.appendChild(div);
      });
    }

    function makeMove(cellIndex) {
      if (!myTurn || board[cellIndex] !== "") return;

      socket.send(JSON.stringify({
        type: "move",
        cell: cellIndex
      }));
    }

    function disableBoard() {
      const cells = document.querySelectorAll(".cell");
      cells.forEach(cell => cell.classList.add("disabled"));
    }
  </script>

</body>
</html>
