<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TicTacToe Online Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #board table { border-collapse: collapse; margin-top: 10px; }
    #board td { width:50px; height:50px; border:1px solid #333; text-align:center; vertical-align: middle; font-size:24px; cursor:pointer; }
    button { margin: 5px; padding: 5px 10px; }
    #log { margin-top: 15px; background: #eee; padding: 10px; height: 150px; overflow-y: scroll; font-size: 12px; }
  </style>
</head>
<body>

<h1>TicTacToe Online - Test Page</h1>

<div>
  Nickname: <b id="nick">Loading...</b>
</div>

<div>
  <button id="btnConnect" disabled>Connect WebSocket</button>
  <button id="btnFindMatch" disabled>Find Match</button>
  <button id="btnCancelMatch" disabled>Cancel Match</button>
  <button id="btnPlayAgain" disabled>Play Again</button>
</div>

<div id="matchInfo"></div>
<div id="gameResult"></div>

<div id="board" style="display:none;">
  <table>
    <tr><td data-cell="0"></td><td data-cell="1"></td><td data-cell="2"></td></tr>
    <tr><td data-cell="3"></td><td data-cell="4"></td><td data-cell="5"></td></tr>
    <tr><td data-cell="6"></td><td data-cell="7"></td><td data-cell="8"></td></tr>
  </table>
</div>

<div>
  <button id="btnGetStats">Get Server Stats</button>
  <span id="serverStats"></span>
</div>

<div>
  <button id="btnGetProfileStats">Get Profile Stats</button>
  <span id="profileStats"></span>
</div>

<div id="log"></div>

<script>
let ws;
let nickname = "";

function log(msg) {
  const logDiv = document.getElementById('log');
  logDiv.textContent += msg + '\\n';
  logDiv.scrollTop = logDiv.scrollHeight;
}

async function init() {
  try {
    const res = await fetch('/api/nickname', { credentials: 'include' });
    const data = await res.json();
    nickname = data.nickname;
    document.getElementById('nick').textContent = nickname;
    document.getElementById('btnConnect').disabled = false;
    log('Nickname loaded: ' + nickname);
  } catch (e) {
    log('Failed to load nickname.');
  }
}

document.getElementById('btnConnect').onclick = () => {
  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('btnFindMatch').disabled = false;
    document.getElementById('btnCancelMatch').disabled = false;
    document.getElementById('btnPlayAgain').disabled = false;
    log('WebSocket connected');
  };
  ws.onclose = () => {
    log('WebSocket disconnected');
  };
  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    log('Received: ' + JSON.stringify(msg));
    handleMessage(msg);
  };
};

function handleMessage(msg) {
  switch (msg.type) {
    case 'match_found':
      document.getElementById('matchInfo').textContent = `Matched vs ${msg.opponent} as ${msg.symbol}`;
      document.getElementById('board').style.display = 'block';
      break;
    case 'match_cancelled':
      document.getElementById('matchInfo').textContent = 'Match search cancelled.';
      break;
    case 'move_made':
      const td = document.querySelector(`td[data-cell="${msg.cell}"]`);
      if (td) td.textContent = msg.by;
      break;
    case 'game_over':
      document.getElementById('gameResult').textContent = `Game Over: ${msg.result}`;
      break;
    case 'opponent_left':
      document.getElementById('gameResult').textContent = 'Opponent left the game.';
      break;
    case 'rematch':
      document.getElementById('matchInfo').textContent = `Rematch vs ${msg.opponent} as ${msg.symbol}`;
      clearBoard();
      document.getElementById('gameResult').textContent = '';
      break;
  }
}

document.getElementById('btnFindMatch').onclick = () => {
  if (ws) ws.send(JSON.stringify({ type: 'find_match' }));
};

document.getElementById('btnCancelMatch').onclick = () => {
  if (ws) ws.send(JSON.stringify({ type: 'cancel_match' }));
};

document.getElementById('btnPlayAgain').onclick = () => {
  if (ws) ws.send(JSON.stringify({ type: 'play_again' }));
};

document.querySelectorAll('#board td').forEach(td => {
  td.onclick = () => {
    const cell = parseInt(td.getAttribute('data-cell'));
    if (ws) ws.send(JSON.stringify({ type: 'move', cell }));
  };
});

document.getElementById('btnGetStats').onclick = async () => {
  try {
    const res = await fetch('/api/stats');
    const data = await res.json();
    document.getElementById('serverStats').textContent = JSON.stringify(data);
    log('Server Stats: ' + JSON.stringify(data));
  } catch (e) {
    log('Failed to load server stats.');
  }
};

document.getElementById('btnGetProfileStats').onclick = async () => {
  try {
    const res = await fetch('/api/profile-stats', { credentials: 'include' });
    const data = await res.json();
    document.getElementById('profileStats').textContent = JSON.stringify(data);
    log('Profile Stats: ' + JSON.stringify(data));
  } catch (e) {
    log('Failed to load profile stats.');
  }
};

function clearBoard() {
  document.querySelectorAll('#board td').forEach(td => td.textContent = '');
}

init();
</script>

</body>
</html>
